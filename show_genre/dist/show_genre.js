!async function(){for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(t=>setTimeout(t,10));(()=>{var t,o,e,d=["user","model","function","system"],u=(0,0,0,0,(e=t=t||{}).FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",e.STOP="STOP",e.MAX_TOKENS="MAX_TOKENS",e.SAFETY="SAFETY",e.RECITATION="RECITATION",e.OTHER="OTHER",0,0,0,class extends Error{constructor(t){super("[GoogleGenerativeAI Error]: "+t)}}),s=class extends u{constructor(t,e){super(t),this.response=e}},h=((e=o=o||{}).GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents",class{constructor(t,e,n,s,o){this.model=t,this.task=e,this.apiKey=n,this.stream=s,this.requestOptions=o}toString(){var t,e=(null==(e=this.requestOptions)?void 0:e.apiVersion)||"v1beta";let n=`${(null==(t=this.requestOptions)?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com"}/${e}/${this.model}:`+this.task;return this.stream&&(n+="?alt=sse"),n}});async function f(t,e,n,s,o,i){t=new h(t,e,n,s,i);return{url:t.toString(),fetchOptions:Object.assign(Object.assign({},function(t){var e={};if(0<=(null==t?void 0:t.timeout)){const s=new AbortController;var n=s.signal;setTimeout(()=>s.abort(),t.timeout),e.signal=n}return e}(i)),{method:"POST",headers:(e=t,(n=new Headers).append("Content-Type","application/json"),n.append("x-goog-api-client",(s=e.requestOptions,i=[],null!=s&&s.apiClient&&i.push(s.apiClient),i.push("genai-js/0.7.1"),i.join(" "))),n.append("x-goog-api-key",e.apiKey),await n),body:o})}}async function i(t,e,n,s,o,i){return async function(e,t,n,s,o,i,a=fetch){var r=new h(e,t,n,s,i);let c;try{var l=await f(e,t,n,s,o,i);if(!(c=await a(l.url,l.fetchOptions)).ok){let t="";try{var d=await c.json();t=d.error.message,d.error.details&&(t+=" "+JSON.stringify(d.error.details))}catch(t){}throw new Error(`[${c.status} ${c.statusText}] `+t)}}catch(t){e=new u(`Error fetching from ${r.toString()}: `+t.message);throw e.stack=t.stack,e}return c}(t,e,n,s,o,i,fetch)}function a(n){return n.text=()=>{if(n.candidates&&0<n.candidates.length){if(1<n.candidates.length&&console.warn(`This response had ${n.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),c(n.candidates[0]))throw new s(""+l(n),n);return null!=(e=null==(e=null==(e=null==(e=(t=n).candidates)?void 0:e[0].content)?void 0:e.parts)?void 0:e[0])&&e.text?t.candidates[0].content.parts.map(({text:t})=>t).join(""):""}if(n.promptFeedback)throw new s("Text not available. "+l(n),n);var t,e;return""},n.functionCall=()=>{if(n.candidates&&0<n.candidates.length){if(1<n.candidates.length&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),c(n.candidates[0]))throw new s(""+l(n),n);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),r(n)[0]}if(n.promptFeedback)throw new s("Function call not available. "+l(n),n)},n.functionCalls=()=>{if(n.candidates&&0<n.candidates.length){if(1<n.candidates.length&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),c(n.candidates[0]))throw new s(""+l(n),n);return r(n)}if(n.promptFeedback)throw new s("Function call not available. "+l(n),n)},n}function r(t){var e,n=[];if(null!=(e=null==(e=t.candidates)?void 0:e[0].content)&&e.parts)for(const s of null==(t=null==(e=t.candidates)?void 0:e[0].content)?void 0:t.parts)s.functionCall&&n.push(s.functionCall);if(0<n.length)return n}var n=[t.RECITATION,t.SAFETY];function c(t){return t.finishReason&&n.includes(t.finishReason)}function l(t){var e;let n="";return t.candidates&&0!==t.candidates.length||!t.promptFeedback?null!=(e=t.candidates)&&e[0]&&c(e=t.candidates[0])&&(n+="Candidate was blocked due to "+e.finishReason,e.finishMessage)&&(n+=": "+e.finishMessage):(n+="Response was blocked",null!=(e=t.promptFeedback)&&e.blockReason&&(n+=" due to "+t.promptFeedback.blockReason),null!=(e=t.promptFeedback)&&e.blockReasonMessage&&(n+=": "+t.promptFeedback.blockReasonMessage)),n}function p(t){return this instanceof p?(this.v=t,this):new p(t)}function g(t,e,n){var o,i,a;if(Symbol.asyncIterator)return o=n.apply(t,e||[]),i=[],a={},s("next"),s("throw"),s("return"),a[Symbol.asyncIterator]=function(){return this},a;throw new TypeError("Symbol.asyncIterator is not defined.");function s(s){o[s]&&(a[s]=function(n){return new Promise(function(t,e){1<i.push([s,n,t,e])||r(s,n)})})}function r(t,e){try{(n=o[t](e)).value instanceof p?Promise.resolve(n.value.v).then(c,l):d(i[0][2],n)}catch(t){d(i[0][3],t)}var n}function c(t){r("next",t)}function l(t){r("throw",t)}function d(t,e){t(e),i.shift(),i.length&&r(i[0][0],i[0][1])}}var m=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function y(t){var[t,e]=function(t){const e=t.getReader(),n=new ReadableStream({start(i){let a="";return function o(){return e.read().then(({value:t,done:e})=>{if(e)return a.trim()?void i.error(new u("Failed to parse stream")):void i.close();let n=(a+=t).match(m),s;for(;n;){try{s=JSON.parse(n[1])}catch(t){return void i.error(new u(`Error parsing JSON response: "${n[1]}"`))}i.enqueue(s),a=a.substring(n[0].length),n=a.match(m)}return o()})}()}});return n}(t.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0}))).tee();return{stream:function(s){return g(this,arguments,function*(){for(var t=s.getReader();;){var{value:e,done:n}=yield p(t.read());if(n)break;yield yield p(a(e))}})}(t),response:async function(t){var e=[],n=t.getReader();for(;;){var{done:s,value:o}=await n.read();if(s)return a(function(t){var e=t[t.length-1],n={promptFeedback:null==e?void 0:e.promptFeedback};for(const i of t)if(i.candidates)for(const a of i.candidates){var s=a.index;if(n.candidates||(n.candidates=[]),n.candidates[s]||(n.candidates[s]={index:a.index}),n.candidates[s].citationMetadata=a.citationMetadata,n.candidates[s].finishReason=a.finishReason,n.candidates[s].finishMessage=a.finishMessage,n.candidates[s].safetyRatings=a.safetyRatings,a.content&&a.content.parts){n.candidates[s].content||(n.candidates[s].content={role:a.content.role||"user",parts:[]});var o={};for(const r of a.content.parts)r.text&&(o.text=r.text),r.functionCall&&(o.functionCall=r.functionCall),0===Object.keys(o).length&&(o.text=""),n.candidates[s].content.parts.push(o)}}return n}(e));e.push(o)}}(e)}}async function w(t,e,n,s){return y(await i(e,o.STREAM_GENERATE_CONTENT,t,!0,JSON.stringify(n),s))}async function v(t,e,n,s){return{response:a(await(await i(e,o.GENERATE_CONTENT,t,!1,JSON.stringify(n),s)).json())}}function C(n){let s=[];if("string"==typeof n)s=[{text:n}];else for(const t of n)"string"==typeof t?s.push({text:t}):s.push(t);{n=s;var o={role:"user",parts:[]},i={role:"function",parts:[]};let t=!1,e=!1;for(const a of n)"functionResponse"in a?(i.parts.push(a),e=!0):(o.parts.push(a),t=!0);if(t&&e)throw new u("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(t||e)return t?o:i;throw new u("No content is provided for sending chat message.")}}function E(t){return t.contents?t:{contents:[C(t)]}}function S(t){return"string"==typeof t||Array.isArray(t)?{content:C(t)}:t}var O=["text","inlineData","functionCall","functionResponse"],T={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall"],system:["text"]},b={user:["model"],function:["model"],model:["user","function"],system:[]};function N(t){let e;for(const a of t){var{role:n,parts:s}=a;if(!e&&"user"!==n)throw new u("First content should be with role 'user', got "+n);if(!d.includes(n))throw new u(`Each item should include role field. Got ${n} but valid roles are: `+JSON.stringify(d));if(!Array.isArray(s))throw new u("Content should have 'parts' property with an array of Parts");if(0===s.length)throw new u("Each Content should have at least one part");var o={text:0,inlineData:0,functionCall:0,functionResponse:0};for(const r of s)for(const c of O)c in r&&(o[c]+=1);var i=T[n];for(const l of O)if(!i.includes(l)&&0<o[l])throw new u(`Content with role '${n}' can't contain '${l}' part`);if(e)if(!b[n].includes(e.role))throw new u(`Content with role '${n}' can't follow '${e.role}'. Valid previous roles: `+JSON.stringify(b));e=a}}var _="SILENT_ERROR",R=class{constructor(t,e,n,s){this.model=e,this.params=n,this.requestOptions=s,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=t,null!=n&&n.history&&(N(n.history),this._history=n.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(t){await this._sendPromise;const n=C(t),e={safetySettings:null==(t=this.params)?void 0:t.safetySettings,generationConfig:null==(t=this.params)?void 0:t.generationConfig,tools:null==(t=this.params)?void 0:t.tools,toolConfig:null==(t=this.params)?void 0:t.toolConfig,systemInstruction:null==(t=this.params)?void 0:t.systemInstruction,contents:[...this._history,n]};let s;return this._sendPromise=this._sendPromise.then(()=>v(this._apiKey,this.model,e,this.requestOptions)).then(t=>{var e;t.response.candidates&&0<t.response.candidates.length?(this._history.push(n),e=Object.assign({parts:[],role:"model"},null==(e=t.response.candidates)?void 0:e[0].content),this._history.push(e)):(e=l(t.response))&&console.warn(`sendMessage() was unsuccessful. ${e}. Inspect response object for details.`),s=t}),await this._sendPromise,s}async sendMessageStream(t){await this._sendPromise;const n=C(t);t={safetySettings:null==(t=this.params)?void 0:t.safetySettings,generationConfig:null==(t=this.params)?void 0:t.generationConfig,tools:null==(t=this.params)?void 0:t.tools,toolConfig:null==(t=this.params)?void 0:t.toolConfig,systemInstruction:null==(t=this.params)?void 0:t.systemInstruction,contents:[...this._history,n]};const e=w(this._apiKey,this.model,t,this.requestOptions);return this._sendPromise=this._sendPromise.then(()=>e).catch(t=>{throw new Error(_)}).then(t=>t.response).then(t=>{var e;t.candidates&&0<t.candidates.length?(this._history.push(n),(e=Object.assign({},t.candidates[0].content)).role||(e.role="model"),this._history.push(e)):(e=l(t))&&console.warn(`sendMessageStream() was unsuccessful. ${e}. Inspect response object for details.`)}).catch(t=>{t.message!==_&&console.error(t)}),e}};async function x(t,e,n,s){return(await i(e,o.COUNT_TOKENS,t,!1,JSON.stringify(Object.assign(Object.assign({},n),{model:e})),s)).json()}async function F(t,e,n,s){return(await i(e,o.EMBED_CONTENT,t,!1,JSON.stringify(n),s)).json()}async function q(t,e,n,s){n=n.requests.map(t=>Object.assign(Object.assign({},t),{model:e}));return(await i(e,o.BATCH_EMBED_CONTENTS,t,!1,JSON.stringify({requests:n}),s)).json()}var K=class{constructor(t,e,n){this.apiKey=t,e.model.includes("/")?this.model=e.model:this.model="models/"+e.model,this.generationConfig=e.generationConfig||{},this.safetySettings=e.safetySettings||[],this.tools=e.tools,this.toolConfig=e.toolConfig,this.systemInstruction=e.systemInstruction,this.requestOptions=n||{}}async generateContent(t){t=E(t);return v(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}async generateContentStream(t){t=E(t);return w(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}startChat(t){return new R(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}async countTokens(t){t=E(t);return x(this.apiKey,this.model,t,this.requestOptions)}async embedContent(t){t=S(t);return F(this.apiKey,this.model,t,this.requestOptions)}async batchEmbedContents(t){return q(this.apiKey,this.model,t,this.requestOptions)}},$=class{constructor(t){this.apiKey=t}getGenerativeModel(t,e){if(t.model)return new K(this.apiKey,t,e);throw new u("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })")}},I=null,k=[],A=null;async function j(t=0){if("undefined"!=typeof Spicetify&&Spicetify.Platform&&Spicetify.Platform.AuthorizationAPI)try{return I=await Spicetify.Platform.Session.accessToken,async function(){var t,e;I?(e=await async function(){var e={Authorization:"Bearer "+I,"Content-Type":"application/json"};try{let t=await fetch("https://api.spotify.com/v1/me/player/currently-playing",{headers:e});var n;return 204!==t.status&&t.ok?(await t.json()).item:0<(n=await(t=await fetch("https://api.spotify.com/v1/me/player/recently-played?limit=1",{headers:e})).json()).items.length?n.items[0].track:null}catch(t){return console.error("Error fetching song data: ",t),null}}())?(t=e.name,e=e.artists[0].name,A=await async function(t,e){var n=new $("AIzaSyDKOdPZGOsD8kCR5ZXhIjGIHde_flrxWuo"),n=n.getGenerativeModel({model:"gemini-pro",generationConfig:{temperature:0,top_p:1,top_k:1,max_output_tokens:100}}),t=`What genre is the song ${t} by ${e}?`,e=await n.generateContent(t),n=e.response.text();return console.log("propmp",t,"response",n),n}(t,e),k&&0!=k.length||M(),k?P(k,A):console.log("Genre display container could not be created."),console.log(t,",",e,":",A)):console.log("No song data available."):console.error("No access token available.")}(),I}catch(t){return console.error("Error retrieving access token:",t),null}else setTimeout(j,1e3)}if(!window.Spicetify)throw new Error("Spicetify is not loaded.");function M(){var t=document.querySelectorAll(".main-trackInfo-container");if(!t||0===t.length)return console.log("Track info container not found."),null;t.forEach(t=>{t.style.gridTemplate='"pretitle pretitle" "title title" "badges subtitle" "genre genre"/auto 1fr';var e,n=document.querySelector(".main-trackinfo-genre");n||((n=document.createElement("div")).className="main-trackInfo-genre",n.style.gridArea="genre",(e=document.createElement("div")).className="Text__TextElement-sc-if376j-0 TextElement-text-marginal-textSubdued encore-text-marginal main-trackInfo-genre",n.appendChild(e),t.appendChild(n),k.push(n))}),A?P(k,A):console.log("Genre not available.")}function P(t,e){t.forEach(t=>{t&&e&&t.textContent!==e&&0<t.childElementCount&&(t.children[0].textContent=e),console.log("updateGenreDisplay",t)})}(async()=>{console.log("Show genre extension loaded!"),document.addEventListener("DOMContentLoaded",M),j()})()})()}();